Module 9: Designing a Communication Strategy by Using Queues and Service
Bus

Lab: Using Queues and Service Bus to Manage Communication Between Web
Applications in Azure

### Exercise 1: Creating an Azure Service Bus Namespace

####   Task 1: Create the Service Bus namespace by using the Management Portal {#task-1-create-the-service-bus-namespace-by-using-the-management-portal .ProcedureHeading}

> ![](media/image1.wmf) **Note:** Service Bus functionality is not
> available yet in the new Preview Portal. Because of this, the existing
> Management Portal will be used for this lab.** **

<span id="List_264" class="anchor"></span>On the Start screen, click the
**Internet Explorer** tile.

<span id="List_263" class="anchor"></span>Go to
[*https://manage.windowsazure.com*](https://manage.windowsazure.com)

<span id="List_262" class="anchor"></span>In the email address box, type
the email address of your Microsoft account.

<span id="List_261" class="anchor"></span>In the password box, type the
password for your Microsoft account.

<span id="List_260" class="anchor"></span>Click **Sign In** In the
navigation pane on the left side, scroll down, and then click **Service
Bus**.

<span id="List_259" class="anchor"></span>At the bottom of the screen,
click **Create**.

<span id="List_258" class="anchor"></span>In the **Create a Namespace**
dialog box, perform the following steps:

<span id="List_257" class="anchor"></span>In the **Namespace** **Name**
box, type **sb20532[*Your Name*]**.

<span id="List_256" class="anchor"></span>In the **Region** list, select
the region that is closest to your location.

<span id="List_255" class="anchor"></span>In the **Type** list, select
the **Messaging** option.

<span id="List_254" class="anchor"></span>In the **Messaging Tier**
list, select the **Standard** option.

<span id="List_253" class="anchor"></span>Click the checkmark button to
create your namespace.

<span id="List_252" class="anchor"></span>In the list of **Service Bus**
namespaces, click the namespace that you just created.

<span id="List_251" class="anchor"></span>At the bottom of the screen,
click **Connection Information**.

<span id="List_250" class="anchor"></span>Record the
RootManageSharedAccessKey connection string from the **Access connection
information** dialog box.

> ![](media/image1.wmf) **Note:** You have to record a connection string
> from the list of SAS items.

<span id="List_247" class="anchor"></span>Close the **Access connection
information** dialog box.

<span id="List_246" class="anchor"></span>At the top of the screen,
click the **Queues** tab.

<span id="List_245" class="anchor"></span>At the bottom-left corner of
the screen, click **New**.

<span id="List_244" class="anchor"></span>If it is not automatically
selected, select **App Services =\> Service Bus =\> Queue =\> Custom
Create**.

<span id="List_243" class="anchor"></span>In the **Create a Queue**
dialog box, perform the following steps:

a.  <span id="List_242" class="anchor"></span>In the **Queue** **Name**
    box, type **signin**.

<span id="List_241" class="anchor"></span>In the **Region** list, select
the same region that you selected for the namespace.

<span id="List_240" class="anchor"></span>In the **Namespace** box,
provide the value **sb20532[Your Name]**.

<span id="List_239" class="anchor"></span>Click next arrow to move to
the next step in the wizard.

<span id="List_238" class="anchor"></span>Leave all fields as their
default values.

<span id="List_237" class="anchor"></span>Click the check mark button to
create the new queue.

**Results**: After completing this exercise, you will have created a
Service Bus namespace by using the Management Portal.

### Exercise 2: Using Azure Queue Storage for Document Generation

####   Task 1: Update worker role to consume requests from the queue {#task-1-update-worker-role-to-consume-requests-from-the-queue .ProcedureHeading}

1.  <span id="List_233" class="anchor"></span>On the Start screen, click
    **Desktop**.

<span id="List_232" class="anchor"></span>On the taskbar, click the
**File Explorer** icon.

<span id="List_231" class="anchor"></span>In the Libraries window, go to
**Allfiles (F):\\Mod09\\Labfiles\\Starter\\Queues\\Contoso.Events**, and
then double-click **Contoso.Events.sln.**

<span id="List_230" class="anchor"></span>In the **Solution Explorer**
pane, expand the **Roles** folder.

<span id="List_229" class="anchor"></span>In the **Solution Explorer**
pane, expand the **Contoso.Events.Worker** project.

<span id="List_228" class="anchor"></span>Double-click the
**TableStorageQueueHelper.cs** file.

<span id="List_227" class="anchor"></span>At the end of the
**TableStorageQueueHelper** constructor and before the closing
parenthesis, store the **StorageAccount** property from the base class
in a *CloudStorageAccount* variable:

CloudStorageAccount storageAccount = base.StorageAccount;

<span id="List_226" class="anchor"></span>Invoke the
**CreateCloudQueueClient** method and assign the result to the
*\_queueClient* variable:

\_queueClient = storageAccount.CreateCloudQueueClient();

<span id="List_225" class="anchor"></span>Invoke the static
**CloudConfigurationManager.GetSetting** method and assign the result to
the *\_signInQueueName* variable:

\_signInQueueName =
CloudConfigurationManager.GetSetting("SignInQueueName");

<span id="List_224" class="anchor"></span>In the
**TableStorageQueueHelper** class, find the constructor with the
following signature:

IQueueMessage\<CloudQueueMessage\> Receive()

<span id="List_223" class="anchor"></span>Remove the single line of code
in the class:

return new TableStorageQueueMessage(null);

<span id="List_222" class="anchor"></span>At the end of the **Receive**
method and before the closing parenthesis, create a new instance of the
**CloudQueue** class by calling the **GetQueueReference** method of the
*CloudQueueClient* variable by using the **string** name of the queue,
as shown in the following code:

CloudQueue queue = \_queueClient.GetQueueReference(\_signInQueueName);

<span id="List_221" class="anchor"></span>Invoke the
**CreateIfNotExists** method to ensure that the queue exists.

queue.CreateIfNotExists();

<span id="List_220" class="anchor"></span>At the end of the **Receive**
method and before the closing parenthesis, invoke the **GetMessage**
method of the **CloudQueue** class and store the result in a
*CloudQueueMessage* variable, as shown in the following code:

CloudQueueMessage message = queue.GetMessage();

<span id="List_219" class="anchor"></span>Pass the *CloudQueueMessage*
variable into the constructor of the **TableStorageQueueMessage** class
and return the result:

return new TableStorageQueueMessage(message);

<span id="List_218" class="anchor"></span>At the end of the
**CompleteMessage** method and before the closing parenthesis, create a
new instance of the **CloudQueue** class by calling the
**GetQueueReference** method of the *CloudQueueClient* variable by using
the **string** name of the queue, as shown in the following code.

CloudQueue queue = \_queueClient.GetQueueReference(\_signInQueueName);

<span id="List_217" class="anchor"></span>Invoke the
**CreateIfNotExists** method to ensure that the queue exists:

queue.CreateIfNotExists();

<span id="List_216" class="anchor"></span>At the end of the
**CompleteMessage** method and before the closing parenthesis, invoke
the **DeleteMessage** method by using the *CloudQueueMessage* variable
as the parameter, as shown in the following code:

<span id="List_215" class="anchor"></span>queue.DeleteMessage(message);

####   Task 2: Update administration application to add requests to the queue {#task-2-update-administration-application-to-add-requests-to-the-queue .ProcedureHeading}

1.  <span id="List_214" class="anchor"></span>In the **Solution
    Explorer** pane, expand the **Shared** folder.

<span id="List_213" class="anchor"></span>In the **Solution Explorer**
pane, expand the **Contoso.Events.ViewModels** project.

<span id="List_212" class="anchor"></span>Double-click the
**SignInSheetViewModel.cs** file.

<span id="List_211" class="anchor"></span>At the beginning of the
**GenerateSignInSheetTableStorage** method and after the opening
parenthesis, create a **CloudStorageAccount** instance by using the
static **CloudStorageAccount.Parse** method and the table storage
connection string, as shown in the following code:

CloudStorageAccount storageAccount =
CloudStorageAccount.Parse(tableStorageConnectionString);

<span id="List_210" class="anchor"></span>Create a new instance of the
**CloudQueueClient** class by using the **CreateCloudQueueClient**
method of the *CloudStorageAccount* variable:

CloudQueueClient queueClient = storageAccount.CreateCloudQueueClient();

<span id="List_209" class="anchor"></span>After the above mentioned
code, create a new instance of the **CloudQueue** class by invoking the
**GetQueueReference** method of the *CloudQueueClient* variable by using
the queue name string variable, as shown in the following code.:

CloudQueue queue = queueClient.GetQueueReference(signInQueueName);

<span id="List_208" class="anchor"></span>Invoke the
**CreateIfNotExists** method of the **CloudQueue** class to ensure that
the queue exists:

queue.CreateIfNotExists();

<span id="List_207" class="anchor"></span>After the above mentioned
code, create a new instance of the **CloudQueueMessage** class by
passing in the string **message** into the constructor:

CloudQueueMessage queueMessage = new CloudQueueMessage(message);

<span id="List_206" class="anchor"></span>Invoke the **AddMessage**
method of the *CloudQueue* variable by using the **CloudQueueMessage**
as the parameter:

<span id="List_205"
class="anchor"></span>queue.AddMessage(queueMessage);

####   Task 3: Generate the test data {#task-3-generate-the-test-data .ProcedureHeading}

1.  <span id="List_204" class="anchor"></span>On the Start screen, type
    **Azure Storage Emulator**.

<span id="List_203" class="anchor"></span>Click the **Windows Azure
Storage Emulator – v3.4** tile.

<span id="List_202" class="anchor"></span>Switch to the **Contoso.Events
– Microsoft Visual Studio** window.

<span id="List_201" class="anchor"></span>In the **Solution Explorer**
pane, right-click **Contoso.Events.Data.Generation project**, point to
**Debug,** and then click **Start New Instance**.

####   Task 4: Debug and verify the application {#task-4-debug-and-verify-the-application .ProcedureHeading}

1.  <span id="List_200" class="anchor"></span>In the **Solution
    Explorer** pane, right-click the **Contoso.Events** solution, and
    then click **Properties**.

<span id="List_199" class="anchor"></span>In the **Solution
'Contoso.Events' Property Pages** dialog box, perform the following
steps:

a.  <span id="List_198" class="anchor"></span>In the navigation menu on
    the left side of the dialog box, ensure that **CommonProperties**
    =\> **Startup Project** is selected.

<span id="List_197" class="anchor"></span>Select **Multiple startup
projects**.

<span id="List_196" class="anchor"></span>For **Contoso.Events.Cloud**,
set the **Action** to **Start**.

<span id="List_195" class="anchor"></span>For
**Contoso.Events.Management**, set the **Action** to **Start without
debugging**.

<span id="List_194" class="anchor"></span>Ensure that all of the
remaining projects have their **Action** set to **None**.

<span id="List_193" class="anchor"></span>Click **OK**.

<span id="List_192" class="anchor"></span>On the **Debug** menu, click
**Start Debugging**.

> <span id="List_191" class="anchor"></span>![](media/image1.wmf)
> **Note:** Throughout this course we will use the **Azure** **Compute**
> **Emulator** to test and debug our Cloud Services. The emulator
> provides a fast and local option for testing your Cloud Services
> before deploying them to the Azure platform. Occasionally you may seem
> an odd error with the emulator such as an incorrect port number or a
> page not displaying. If this ever occurs, you can simply **Shutdown**
> the compute emulator and Visual Studio will **Start** the emulator the
> next time you try to debug your project.** **

<span id="List_189" class="anchor"></span>In the **notification area**,
click the arrow to view the running applications.

<span id="List_188" class="anchor"></span>Locate and right-click the IIS
Express icon.

<span id="List_187" class="anchor"></span>Point to the
**Contoso.Events.Management** option under the **View Sites** header,
and then click the URL under the **Browse Applications** header.

<span id="List_186" class="anchor"></span>Point to the
**Contoso.Events.Cloud** option under the **View Sites** header, and
then click the URL under **Browse Applications**.

<span id="List_185" class="anchor"></span>On the desktop, click the
**Contoso.Events – Microsoft Visual Studio** window.

<span id="List_184" class="anchor"></span>Click the **View** menu and
select the **Solution Explorer** option.

<span id="List_183" class="anchor"></span>In the **Solution Explorer**
pane, expand the **Roles** folder.

<span id="List_182" class="anchor"></span>In the **Solution Explorer**
pane, expand the **Contoso.Events.Worker** project.

<span id="List_181" class="anchor"></span>Double-click the
**WorkerRole.cs** file.

<span id="List_180" class="anchor"></span>Locate the **Run** method.

<span id="List_179" class="anchor"></span>Locate the target line of code
within the try-catch block:

HandleMessage(message);

<span id="List_178" class="anchor"></span>Right-click the target line of
code, point to **Breakpoint**, and click **Insert Breakpoint**.

<span id="List_177" class="anchor"></span>On the desktop, click the
**Home - Contoso.Events.Administration** window.

<span id="List_176" class="anchor"></span>On the home page of the
**Administration** web application, click the **Events** button to go to
the list of events.

<span id="List_175" class="anchor"></span>Click **Sign-In Sheet** for
any event in the list.

<span id="List_174" class="anchor"></span>View the sign-in page which
notifies you that the sign-in sheet is being generated with the
following message: **Sign-In Document Generation in Progress**.

<span id="List_173" class="anchor"></span>Wait for one minute for the
worker role to receive the queue message.

<span id="List_172" class="anchor"></span>Verify that the application
temporarily pauses execution at the breakpoint.

<span id="List_171" class="anchor"></span>Press F5 to resume execution
of the application.

<span id="List_170" class="anchor"></span>Wait for one minute, and then
refresh the sign-in sheet page.

<span id="List_169" class="anchor"></span>Click **Sign-In Sheet** to
download the sign-in sheet from the server.

<span id="List_168" class="anchor"></span>Close the **Internet
Explorer** application.

**Results**: After completing this exercise, you will have created and
consumed messages from Storage queues.

### Exercise 3: Using Service Bus Queues for Document Generation

####   Task 1: Update worker role to consume requests from the queue {#task-1-update-worker-role-to-consume-requests-from-the-queue-1 .ProcedureHeading}

1.  <span id="List_165" class="anchor"></span>In the **Solution
    Explorer** pane, expand the **Contoso.Events.Cloud** project.

<span id="List_164" class="anchor"></span>Double-click the
**ServiceConfiguration.Local.cscfg** file.

<span id="List_163" class="anchor"></span>Locate the **Setting** element
with the name **Microsoft.ServiceBus.ConnectionString**.

<span id="List_162" class="anchor"></span>Replace the value with your
previously recorded connection string.

<span id="List_161" class="anchor"></span>In the **Solution Explorer**
pane, expand the **Roles** folder.

<span id="List_160" class="anchor"></span>In the **Solution Explorer**
pane, expand the **Contoso.Events.Worker** project.

<span id="List_159" class="anchor"></span>Double-click the
**ServiceBusQueueHelper.cs** file.

<span id="List_158" class="anchor"></span>At the end of the
**ServiceBusQueueHelper** constructor and before the closing
parenthesis, store the **Microsoft**.**ServiceBus.ConnectionString**
setting value from your Cloud configuration in a string variable, as
shown in the following code:

string serviceBusConnectionString =
CloudConfigurationManager.GetSetting("Microsoft.ServiceBus.ConnectionString");

<span id="List_157" class="anchor"></span>Store the queue name in a
string variable.

string signInQueueName =
CloudConfigurationManager.GetSetting("SignInQueueName");

<span id="List_156" class="anchor"></span>Invoke the static
**QueueClient.CreateFromConnectionString** method using the queue name
and connection string as parameters, and assign the result to the
*\_client* variable, as shown in the following code:

\_client =
QueueClient.CreateFromConnectionString(serviceBusConnectionString,
signInQueueName);

<span id="List_155" class="anchor"></span>In the
**ServiceBusQueueHelper** class, find the method with the following
signature:

IQueueMessage\<BrokeredMessage\> Receive()

<span id="List_154" class="anchor"></span>Remove the single line of code
in the class:

return new ServiceBusQueueMessage(null);

<span id="List_153" class="anchor"></span>At the end of the **Receive**
method and before the closing parenthesis, create a new instance of the
**CloudQueue** class by calling the **GetQueueReference** method of the
*CloudQueueClient* variable using the **string** name of the queue, as
shown in the following code:

BrokeredMessage message = \_client.Receive();

<span id="List_152" class="anchor"></span>Invoke the
**CreateIfNotExists** method to ensure that the queue exists

return new ServiceBusQueueMessage(message);

<span id="List_151" class="anchor"></span>At the end of the
**CompleteMessage** method and before the closing parenthesis, invoke
the **Complete** method on the **message** parameter, as shown in the
following code:

message.Complete();

<span id="List_150" class="anchor"></span>At the end of the
**AbandonMessage** method and before the closing parenthesis, invoke the
**Abandon** method on the **message** parameter, as shown below:

message.Abandon();

<span id="List_149" class="anchor"></span>In the **Solution Explorer**
pane, expand the **Roles** folder.

<span id="List_148" class="anchor"></span>In the **Solution Explorer**
pane, expand the **Contoso.Events.Worker** project.

<span id="List_147" class="anchor"></span>Double-click the
**WorkerRole.cs** file.

<span id="List_146" class="anchor"></span>Locate and replace the line of
code creating the **TableStorageQueueHelper**:

var queueHelper = new TableStorageQueueHelper();

with a line creating a new instance of the **ServiceBusQueueHelper**

<span id="List_145" class="anchor"></span>var queueHelper = new
ServiceBusQueueHelper();

####   Task 2: Update administration application to add requests to the queue {#task-2-update-administration-application-to-add-requests-to-the-queue-1 .ProcedureHeading}

1.  <span id="List_144" class="anchor"></span>In the **Solution
    Explorer** pane, expand the **Administration** folder and then
    expand the **Contoso.Events.Management** project.

<span id="List_143" class="anchor"></span>Double-click the
**Web.config** file.

<span id="List_142" class="anchor"></span>Locate the **appSettings**
element.

<span id="List_141" class="anchor"></span>Locate the **add** element
with the key **Microsoft.ServiceBus.ConnectionString**.

<span id="List_140" class="anchor"></span>Replace the value with your
previously recorded connection string.

<span id="List_139" class="anchor"></span>In the **Solution Explorer**
pane, expand the **Shared** folder.

<span id="List_138" class="anchor"></span>In the **Solution Explorer**
pane, expand the **Contoso.Events.ViewModels** project.

<span id="List_137" class="anchor"></span>Double-click the
**SignInSheetViewModel.cs** file.

<span id="List_136" class="anchor"></span>In the constructor, locate the
following line of code:

GenerateSignInSheetTableStorage(context, eventItem, messageString);

<span id="List_135" class="anchor"></span>Replace the above line of code
with the following line of code:

GenerateSignInSheetServiceBus(context, eventItem, message);

<span id="List_134" class="anchor"></span>At the beginning of the
**GenerateSignInSheetServiceBus** method and after the opening
parenthesis, create a **QueueClient** instance by using the connection
string, as shown in the following code:

QueueClient client =
QueueClient.CreateFromConnectionString(serviceBusConnectionString,
signInQueueName);

<span id="List_133" class="anchor"></span>After the above code, create a
new instance of the **BrokeredMessage** class by passing in the
**QueueMessage** message into the constructor, as shown in the following
code:

BrokeredMessage queueMessage = new BrokeredMessage(message);

<span id="List_132" class="anchor"></span>Invoke the **Send** method of
the *QueueClient* variable by using the **BrokeredMessage** as the
parameter:

<span id="List_131" class="anchor"></span>client.Send(queueMessage);

####   Task 3: Debug and verify the application {#task-3-debug-and-verify-the-application .ProcedureHeading}

1.  <span id="List_130" class="anchor"></span>On the **Debug** menu,
    click **Start Debugging**.

<span id="List_129" class="anchor"></span>In the notification area,
click the arrow to view the running application.

<span id="List_128" class="anchor"></span>Locate the **IIS Express**
icon, and then right-click the icon.

<span id="List_127" class="anchor"></span>Point to the
**Contoso.Events.Management** option under the **View Sites** header,
and then click the URL under **Browse Applications**.

<span id="List_126" class="anchor"></span>Point to the
**Contoso.Events.Cloud** option under the **View Sites** header, and
then click the URL under **Browse Applications**.

<span id="List_125" class="anchor"></span>On the home page for the
**Administration** web application, click the **Events** button to view
the list of events.

<span id="List_124" class="anchor"></span>Click the **Sign-In Sheet**
button for any event in the list.

<span id="List_123" class="anchor"></span>View the sign-in page which
notifies you that the sign-in sheet is being generated with the message:
**Sign-In Document Generation in Progress**.

<span id="List_122" class="anchor"></span>Wait for one minute for the
worker role to receive the queue message.

<span id="List_121" class="anchor"></span>Verify that the application
temporarily pauses execution at the breakpoint.

<span id="List_120" class="anchor"></span>Press F5 to resume execution
of the application

<span id="List_119" class="anchor"></span>Wait for one minute, and then
refresh the sign-in sheet page.

<span id="List_118" class="anchor"></span>Click **Sign-In Sheet** to
download the sign-in sheet from the server.

<span id="List_117" class="anchor"></span>Close the **Internet
Explorer** window.

<span id="List_116" class="anchor"></span>Close the **Contoso.Events –
Microsoft Visual Studio** window.

**Results**: After completing this exercise, you will have created and
consumed messages from Service Bus Queues.

### Exercise 4: Using Service Bus Relay to Connect a WCF Service and Client[s]

####   Task 1: Test the existing WCF service by using a console application {#task-1-test-the-existing-wcf-service-by-using-a-console-application .ProcedureHeading}

1.  <span id="List_113" class="anchor"></span>On the Start screen, click
    **Desktop**.

<span id="List_112" class="anchor"></span>On the taskbar, click the
**File Explorer** icon.

<span id="List_111" class="anchor"></span>In the Libraries window, go to
**Allfiles (F):\\Mod09\\Labfiles\\Starter\\Relay\\Contoso.Events**, and
then double-click **Contoso.Events.sln.**

<span id="List_110" class="anchor"></span>On the Start screen, click
**Desktop**.

<span id="List_109" class="anchor"></span>On the taskbar, click the
**File Explorer** icon.

<span id="List_108" class="anchor"></span>In the Libraries window, go to
**Allfiles (F):\\Mod09\\
Labfiles\\Starter\\Relay\\Contoso.Events.Lodging.Client**, and then
double-click **Contoso.Events.Lodging.Client.sln.**

<span id="List_107" class="anchor"></span>On the desktop, click the
**Contoso.Events – Microsoft Visual Studio** window.

<span id="List_106" class="anchor"></span>In the **Solution Explorer**
pane, expand the **On-Premise** folder, right-click the
**Contoso.Events.Lodging** project, and then click **Set as Startup
Project**.

<span id="List_105" class="anchor"></span>On the **Debug** menu, click
**Start Debugging**.

<span id="List_104" class="anchor"></span>You will see a prompt
indicating that the WCF service does not have any metadata and inquiring
whether or not you wish to exit the debugging process. Click **No**.

<span id="List_103" class="anchor"></span>Minimize **WCF Test Client**.

<span id="List_102" class="anchor"></span>On the desktop, click the
**Contoso.Events.Lodging.Client** **– Microsoft Visual Studio** window.

<span id="List_101" class="anchor"></span>On the **Debug** menu, click
**Start Debugging**.

<span id="List_100" class="anchor"></span>Verify that the four hotel
names are listed.

<span id="List_99" class="anchor"></span>Press any key in the console
window to close the window.

<span id="List_98" class="anchor"></span>On the desktop, click the
**Contoso.Events – Microsoft Visual Studio** window.

<span id="List_97" class="anchor"></span>On the **Debug** menu, click
**Stop Debugging**.

####   Task 2: Modify the WCF service endpoints to use Service Bus relay {#task-2-modify-the-wcf-service-endpoints-to-use-service-bus-relay .ProcedureHeading}

1.  <span id="List_96" class="anchor"></span>On the desktop, click the
    **Contoso.Events – Microsoft Visual Studio** window.

<span id="List_95" class="anchor"></span>In the **Solution Explorer**
pane, expand the **On-Premise** folder.

<span id="List_94" class="anchor"></span>In the **Solution Explorer**
pane, expand the **Contoso.Events.Lodging** project.

<span id="List_93" class="anchor"></span>Double-click the **App.config**
file.

<span id="List_92" class="anchor"></span>Locate the
**system.serviceModel** XML element.

<span id="List_91" class="anchor"></span>Locate the **services** child
XML element.

<span id="List_90" class="anchor"></span>Locate the first **endpoint**
child XML element with a **contract** value of
**Contoso.Events.Models.ILodgingService**.

<span id="List_89" class="anchor"></span>Replace the value of the
**binding** attribute with the value: **netTcpRelayBinding**.

<span id="List_88" class="anchor"></span>Locate the first **endpoint**
child XML element with a **contract** value of
**Contoso.Events.Models.ILodgingService**.

<span id="List_87" class="anchor"></span>Replace the value of the
**address** attribute with the value: **sb://**.

<span id="List_86" class="anchor"></span>Append the **address**
attribute’s value with the name of your namespace.

<span id="List_85" class="anchor"></span>Append the **address**
attribute’s value with the value: **.servicebus.windows.net/lodging**.

<span id="List_84" class="anchor"></span>Locate the
**system.serviceModel** XML element.

<span id="List_83" class="anchor"></span>Locate the **behaviors** child
XML element.

<span id="List_82" class="anchor"></span>Locate the
**endpointBehaviors** child XML element.

<span id="List_81" class="anchor"></span>Locate the first **behavior**
child XML element with a **name** value of **ServiceBusRelayBehavior**,
as shown in the following code:

\<behavior name="ServiceBusRelayBehavior"\>

\</behavior\>

<span id="List_80" class="anchor"></span>Within the tags of the
**behavior** element, add a **transportClientEndpointBehavior** element,
as shown in the following code::

\<transportClientEndpointBehavior\>

\</transportClientEndpointBehavior\>

<span id="List_79" class="anchor"></span>Within the tags of the
**transportClientEndpointBehavior** element, add a **tokenProvider**
element, as shown in the following code:

\<tokenProvider\>

\</tokenProvider\>

<span id="List_78" class="anchor"></span>Within the tags of the
**tokenProvider** element, add a **sharedAccessSignature** element.

\<sharedAccessSignature keyName="[keyName]" key="[key]" /\>

<span id="List_77" class="anchor"></span>Within the
**sharedAccessSignature** element,

<span id="List_76" class="anchor"></span>Remove the value of the
**keyName** attribute.

<span id="List_75" class="anchor"></span>Replace the value of the
**keyName** attribute with the **SharedAccessKeyName** value from your
previously recorded Service Bus connection string.

<span id="List_74" class="anchor"></span>Within the
**sharedAccessSignature** element, remove the value of the **key**
attribute.

<span id="List_73" class="anchor"></span>Replace the value of the
**key** attribute with the **SharedAccessKey** value from your
previously recorded Service Bus connection string.

> ![](media/image1.wmf) **Note:** For example your connection string may
> be:
>
> Endpoint=sb://contoso.servicebus.windows.net/;
>
> SharedAccessKeyName=RootManageSharedAccessKey;
>
> SharedAccessKey=ABC123/J3y+tk=<span id="List_72"
> class="anchor"></span>Your **keyName** value would be
> “*RootManageSharedAccessKey*” and your **key** value would be
> “*ABC123/J3y+tk=”*.** **

<span id="List_70" class="anchor"></span>In the **Solution Explorer**
pane, expand the **On-Premise** solution folder, right-click the
**Contoso.Events.Lodging** project, and then click **Set as Startup
Project**.

<span id="List_69" class="anchor"></span>On the **Debug** menu, click
**Start Debugging**.

<span id="List_68" class="anchor"></span>You will see a prompt
indicating that the WCF service does not have any metadata and inquiring
whether or not you wish to exit the debugging process. Click **No**.

<span id="List_67" class="anchor"></span>Minimize, but do not close, the
**WCF Test Client** application.

####   Task 3: Test the relayed WCF service by using a console application {#task-3-test-the-relayed-wcf-service-by-using-a-console-application .ProcedureHeading}

1.  <span id="List_66" class="anchor"></span>On your desktop, click the
    **Contoso.Events.Lodging.Client – Microsoft Visual Studio** window.

<span id="List_65" class="anchor"></span>In the **Solution Explorer**
pane, expand the **Contoso.Events.Lodging.Client** project.

<span id="List_64" class="anchor"></span>Double-click the **Program.cs**
file.

<span id="List_63" class="anchor"></span>Locate the method with the
following signature:

private static IEnumerable\<Hotel\> GetHotels()

<span id="List_62" class="anchor"></span>Remove the line that creates a
Uri by using a static string, as shown in the following code:

Uri serviceUri = new Uri("net.tcp://localhost:8000/lodging",
UriKind.Absolute);

<span id="List_61" class="anchor"></span>Replace the line with a line of
code that creates a Uri by invoking the static method
**ServiceBusEnvironment.CreateServiceUri** with the protocol, namespace,
and relative name as its parameters, as shown in the following code:

Uri serviceUri = ServiceBusEnvironment.CreateServiceUri("sb",
"[namespace]", "lodging");

<span id="List_60" class="anchor"></span>On the previous line of code,
update the parameters for the **CreateServiceUri** method by replacing
the **“[*namespace*]”** string with your Service Bus namespace.

<span id="List_59" class="anchor"></span>Remove the following line:

new NetTcpBinding(),

<span id="List_58" class="anchor"></span>Replace the line with a line of
code that creates a new instance of the **NetTcpRelayBinding** class:

new NetTcpRelayBinding(),

<span id="List_57" class="anchor"></span>On the next line after the
**ChannelFactory\<ILodgingService**\> instance is created, create an
instance of the **TransportClientEndpointBehavior** class:

TransportClientEndpointBehavior endpointBehavior = new
TransportClientEndpointBehavior();

<span id="List_56" class="anchor"></span>On the next line, set the
*TransportClientEndpointBehavior* variable’s **TokenProvider** property
to the result of an invocation of the
**TokenProvider.CreateSharedSecretTokenProvider** static method:

endpointBehavior.TokenProvider =
TokenProvider.CreateSharedAccessSignatureTokenProvider("[keyName]",
"[key]");

<span id="List_55" class="anchor"></span>On the previous line of code,
update the parameters for the **CreateSharedSecretTokenProvider** method
by replacing the **“[key]”** string with the **SharedAccessKey** value
of your previously recorded Service Bus connection string.

<span id="List_54" class="anchor"></span>On the previous line of code,
update the parameters for the **CreateSharedSecretTokenProvider** method
by replacing the **“[keyName]”** string with the **SharedAccessKeyName**
value of your previously recorded Service Bus connection string.

<span id="List_53" class="anchor"></span>Add the new instance of the
**TransportClientEndpointBehavior** to the **EndpointBehaviors**
collection property of the **cf.Endpoint** variable:

cf.Endpoint.EndpointBehaviors.Add(endpointBehavior);

<span id="List_52" class="anchor"></span>On the **Debug** menu, click
**Start Debugging**.

<span id="List_51" class="anchor"></span>Verify that the hotels are
listed.

<span id="List_50" class="anchor"></span>Press any key in the console
window to close the window.

####   Task 4: Update the cloud web application to connect to the relayed WCF service {#task-4-update-the-cloud-web-application-to-connect-to-the-relayed-wcf-service .ProcedureHeading}

1.  <span id="List_49" class="anchor"></span>Locate the **Program.cs**
    file in the **Contoso.Events.Lodging.Client** project.

<span id="List_48" class="anchor"></span>Locate the method with the
following signature.

private static IEnumerable\<Hotel\> GetHotels()

<span id="List_47" class="anchor"></span>Select the method signature and
body.

<span id="List_46" class="anchor"></span>Right-click the **selection**,
and then click **Copy** to copy the entire method.

<span id="List_45" class="anchor"></span>On the desktop, click the
**Contoso.Events – Microsoft Visual Studio** window.

<span id="List_44" class="anchor"></span>On the **Debug** menu, click
**Stop Debugging**.

<span id="List_43" class="anchor"></span>In the **Solution Explorer**
pane, expand the **Shared** folder.

<span id="List_42" class="anchor"></span>In the **Solution Explorer**
pane, expand the **Contoso.Events. ViewModels** project.

<span id="List_41" class="anchor"></span>Double-click the
**HotelsViewModel.cs** file.

<span id="List_40" class="anchor"></span>Locate the method with the
following signature:

private static IEnumerable\<Hotel\> GetHotels()

<span id="List_39" class="anchor"></span>Select the entire method
signature and body.

<span id="List_38" class="anchor"></span>Right-click the selection, and
then click **Paste** to paste the entire method.

####   Task 5: Debug the cloud web application {#task-5-debug-the-cloud-web-application .ProcedureHeading}

1.  <span id="List_37" class="anchor"></span>In the **Solution
    Explorer** pane, right-click the **Contoso.Events** solution, and
    then click **Properties**.

<span id="List_36" class="anchor"></span>In the **Solution
‘Contoso.Events’ Property Pages** dialog box, perform the following
steps:

a.  <span id="List_35" class="anchor"></span>Make sure that
    **CommonProperties =\> Startup Project** is selected in the
    navigation menu on the left side.

<span id="List_34" class="anchor"></span>Select **Multiple startup
projects**.

<span id="List_33" class="anchor"></span>For **Contoso.Events.Cloud**,
set the **Action** to **Start without debugging**.

<span id="List_32" class="anchor"></span>For **Contoso.Events.Lodging**,
set the **Action** to **Start without debugging**.

<span id="List_31" class="anchor"></span>For
**Contoso.Events.Management**, set the **Action** to **None**.

<span id="List_30" class="anchor"></span>Ensure that all the remaining
projects have their **Action** set to **None**.

<span id="List_29" class="anchor"></span>Click **OK**.

<span id="List_28" class="anchor"></span>On the Start screen, type
**Azure Storage Emulator**.

<span id="List_27" class="anchor"></span>Click the **Windows Azure
Storage Emulator – v3.4** tile.

<span id="List_26" class="anchor"></span>Switch to the **Contoso.Events
– Microsoft Visual Studio** window.

<span id="List_25" class="anchor"></span>In the **Solution Explorer**
pane, right-click the **Contoso.Events.Data.Generation project**, point
to **Debug**, and then click **Start New Instance**.

<span id="List_24" class="anchor"></span>Wait for the debug process to
complete and for the console window to close.

<span id="List_23" class="anchor"></span>Close the **Contoso.Events –
Microsoft Visual Studio** application.

<span id="List_22" class="anchor"></span>On the Start screen, locate the
**Visual Studio 2013** tile, right-click, and then select **Run as
Administrator**.

> ![](media/image1.wmf) **Note:** You might have to use the down arrow
> to locate the Visual Studio 2013 tile on your Start screen. After you
> start the application in the administrator context, you might see the
> UAC prompt. Select **Yes** to continue.

<span id="List_19" class="anchor"></span>On the **File** menu, point to
**Open**, and then click **Project/Solution**.

<span id="List_18" class="anchor"></span>In the **Open Project** dialog
box, perform the following steps:

a.  <span id="List_17" class="anchor"></span>Go to **Allfiles
    (F):\\Mod09\\Labfiles\\Starter\\Relay\\Contoso.Events**.

<span id="List_16" class="anchor"></span>Click the **Contoso.Events**
Microsoft Visual Studio Solution file.

<span id="List_15" class="anchor"></span>Click **Open**.

<span id="List_14" class="anchor"></span>On the **Debug** menu, click
**Start without Debugging**.

<span id="List_13" class="anchor"></span>You will see a prompt
indicating that the WCF service does not have any metadata and inquiring
whether or not you wish to exit the debugging process. Click **No**.

<span id="List_12" class="anchor"></span>Minimize, but do not close, the
**WCF Test Client** application.

<span id="List_11" class="anchor"></span>On the home page of the web
application, click any event.

<span id="List_10" class="anchor"></span>On the event details page,
click **Register Now**.

<span id="List_9" class="anchor"></span>Complete the Registration form
with any arbitrary values.

<span id="List_8" class="anchor"></span>Click **Submit**.

<span id="List_7" class="anchor"></span>Observe that the **Registration
Confirmation** web page shows a list of hotels.

<span id="List_6" class="anchor"></span>Close the **Internet Explorer**
application.

<span id="List_5" class="anchor"></span>Close the **Microsoft Visual
Studio** applications.

<span id="List_4" class="anchor"></span>Close the **Windows Azure
Storage Emulator** command prompt.

**Results**: After completing this exercise, you will have connected
existing WCF applications to clients by using Service Bus relay.

### \

©2014 Microsoft Corporation. All rights reserved.  The text in this
document is available under the [Creative Commons Attribution 3.0
License](https://creativecommons.org/licenses/by/3.0/legalcode),
additional terms may apply.  All other content contained in this
document (including, without limitation, trademarks, logos, images,
etc.) are ***not*** included within the Creative Commons license grant. 
This document does not provide you with any legal rights to any
intellectual property in any Microsoft product. You may copy and use
this document for your internal, reference purposes. 

This document is provided "as-is." Information and views expressed in
this document, including URL and other Internet Web site references, may
change without notice. You bear the risk of using it. Some examples are
for illustration only and are fictitious. No real association is
intended or inferred. Microsoft makes no warranties, express or implied,
with respect to the information provided here. 
